services:
  api:
    build:
      context: ./services/api
    volumes:
      - ./services/api:/app
    ports:
      - "8000:8000"
    environment:
      - PYTHONPATH=/app
      - API_AUTH_ENABLED=true
      - API_OIDC_JWKS_URL=http://identity:8000/.well-known/jwks.json
      - API_OIDC_ISSUER=http://identity:8000
      - API_OIDC_AUDIENCE=couchannel-api
    depends_on:
      - identity
    command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]

  identity:
    build:
      context: ./services/identity
    volumes:
      - ./services/identity:/app
    ports:
      - "8101:8000"
    environment:
      - PYTHONPATH=/app
      - IDENTITY_REDIS_URL=redis://redis:6379/0
    depends_on:
      - redis
    command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]

  inventory:
    build:
      context: ./services/inventory
    volumes:
      - ./services/inventory:/app
    ports:
      - "8102:8000"
    environment:
      - PYTHONPATH=/app
      - INVENTORY_DATABASE_URL=postgresql+psycopg://couchchannel:couchchannel@db:5432/couchchannel
      - INVENTORY_KAFKA_BOOTSTRAP=redpanda:9092
      - INVENTORY_KAFKA_TOPIC=booking.events
      - INVENTORY_KAFKA_ENABLED=true
    depends_on:
      - db
      - redpanda
    command: ["sh", "-c", "alembic upgrade head && uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload"]

  booking:
    build:
      context: ./services/booking
    volumes:
      - ./services/booking:/app
    ports:
      - "8103:8000"
    environment:
      - PYTHONPATH=/app
      - BOOKING_KAFKA_BOOTSTRAP=redpanda:9092
      - BOOKING_KAFKA_TOPIC=booking.events
      - BOOKING_KAFKA_ENABLED=true
      - BOOKING_DATABASE_URL=postgresql+psycopg://couchchannel:couchchannel@db:5432/couchchannel
    depends_on:
      - redpanda
    command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]

  web:
    build:
      context: ./apps/web
    volumes:
      - ./apps/web:/app
    ports:
      - "5173:5173"
    depends_on:
      - api
      - identity
      - inventory
      - booking
    command: ["sh", "-c", "npm install && npm run dev -- --host 0.0.0.0 --port 5173"]

  analytics:
    build:
      context: ./services/analytics
    volumes:
      - ./services/analytics:/app
    ports:
      - "8104:8000"
    environment:
      - PYTHONPATH=/app
      - ANALYTICS_KAFKA_BOOTSTRAP=redpanda:9092
      - ANALYTICS_KAFKA_TOPIC=booking.events
      - ANALYTICS_KAFKA_ENABLED=true
      - ANALYTICS_DATABASE_URL=postgresql+psycopg://couchchannel:couchchannel@db:5432/couchchannel
    depends_on:
      - db
      - redpanda
    command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]

  tests:
    image: python:3.12-slim
    working_dir: /workspace
    environment:
      - PYTHONPATH=/workspace
      - BOOKING_KAFKA_ENABLED=false
      - INVENTORY_KAFKA_ENABLED=false
      - API_AUTH_ENABLED=false
    volumes:
      - .:/workspace
    command: ["bash", "-lc", "pip install -r requirements-dev.txt && pytest"]

  db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=couchchannel
      - POSTGRES_PASSWORD=couchchannel
      - POSTGRES_DB=couchchannel
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:v24.2.3
    command:
      - redpanda start --overprovisioned --smp 1 --memory 1G --reserve-memory 0M --node-id 0 --check=false
    ports:
      - "9092:9092"
      - "9644:9644"

  prometheus:
    image: prom/prometheus:v2.53.0
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"

  grafana:
    image: grafana/grafana:10.4.3
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
    ports:
      - "3000:3000"
    depends_on:
      - prometheus

volumes:
  postgres-data:
